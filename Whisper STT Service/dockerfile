# Use a CUDA-enabled Python 3.9 base image for GPU support
FROM nvidia/cuda:11.8.0-runtime-ubuntu20.04

# Set the working directory
WORKDIR /app

# Set the timezone non-interactively
ENV DEBIAN_FRONTEND=noninteractive

# Update and install dependencies, including pip
RUN apt-get update && apt-get install -y \
    tzdata \
    ffmpeg \
    build-essential \
    python3-dev \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Upgrade setuptools and wheel
RUN pip3 install --no-cache-dir --upgrade setuptools wheel

# Install dependencies for Cython, NumPy, and SciPy
RUN pip3 install --no-cache-dir cython numpy==1.23.5 scipy

# Install PyTorch with CUDA support from the official PyTorch index
RUN pip3 install --no-cache-dir torch==1.10.1+cu113 torchvision==0.11.2+cu113 torchaudio==0.10.1+cu113 -f https://download.pytorch.org/whl/torch_stable.html

# Install openai-whisper and flask (use a stable release)
RUN pip3 install --no-cache-dir openai-whisper flask

# Copy the application code into the container
COPY . /app

# Expose the application port (if needed for Flask)
EXPOSE 5000

# Command to run the app (you can adjust this for your setup)
CMD ["python3", "stt_service.py"]
